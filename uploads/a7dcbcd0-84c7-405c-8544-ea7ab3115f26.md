# Laravel Sail Production - Script Collection

All scripts from the deployment guide in one convenient location.

---

## deploy.sh - Manual Deployment Script

```bash
#!/bin/bash

# Laravel Production Deployment Script
# Usage: ./deploy.sh

set -e

echo "ðŸš€ Starting deployment..."

# Configuration
APP_DIR="/var/www/laravel-app"
BRANCH="main"

# Navigate to application directory
cd $APP_DIR

# Pull latest changes
echo "ðŸ“¦ Pulling latest changes from GitHub..."
git pull origin $BRANCH

# Stop running containers
echo "ðŸ›‘ Stopping containers..."
docker-compose -f docker-compose.production.yml down

# Rebuild image
echo "ðŸ”¨ Building Docker image..."
docker build -f Dockerfile.production -t laravel-app:latest .

# Start containers
echo "â–¶ï¸  Starting containers..."
docker-compose -f docker-compose.production.yml up -d

# Wait for services to be ready
echo "â³ Waiting for services..."
sleep 10

# Run Laravel commands
echo "ðŸ”§ Running Laravel commands..."
docker exec laravel-app php artisan migrate --force
docker exec laravel-app php artisan config:cache
docker exec laravel-app php artisan route:cache
docker exec laravel-app php artisan view:cache

# Set permissions
echo "ðŸ” Setting permissions..."
docker exec laravel-app chown -R www-data:www-data /var/www/html/storage
docker exec laravel-app chown -R www-data:www-data /var/www/html/bootstrap/cache

# Clean up old images
echo "ðŸ§¹ Cleaning up..."
docker image prune -f

echo "âœ… Deployment completed successfully!"

# Show running containers
docker ps

# Show recent logs
echo ""
echo "ðŸ“‹ Recent logs:"
docker-compose -f docker-compose.production.yml logs --tail=50 app
```

---

## backup.sh - Database and Storage Backup

```bash
#!/bin/bash

# Laravel Production Backup Script

BACKUP_DIR="/var/backups/laravel"
DATE=$(date +%Y%m%d-%H%M%S)
APP_DIR="/var/www/laravel-app"

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
echo "Backing up database..."
docker exec laravel-mysql mysqldump -u root -p${DB_PASSWORD} ${DB_DATABASE} | gzip > $BACKUP_DIR/db-$DATE.sql.gz

# Backup storage files
echo "Backing up storage..."
tar -czf $BACKUP_DIR/storage-$DATE.tar.gz -C $APP_DIR storage/app

# Backup environment file
echo "Backing up environment..."
cp $APP_DIR/.env.production $BACKUP_DIR/env-$DATE

# Keep only last 30 days of backups
find $BACKUP_DIR -type f -mtime +30 -delete

echo "Backup completed: $DATE"
```

---

## monitor.sh - Container Monitoring

```bash
#!/bin/bash

# Monitor Laravel Docker containers

echo "=== Container Status ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo ""
echo "=== Resource Usage ==="
docker stats --no-stream

echo ""
echo "=== Disk Usage ==="
docker system df

echo ""
echo "=== Application Logs (last 20 lines) ==="
docker logs laravel-app --tail=20

echo ""
echo "=== Queue Status ==="
docker exec laravel-app php artisan queue:work --once --quiet && echo "Queue OK" || echo "Queue ERROR"
```

---

## rollback.sh - Rollback to Previous Version

```bash
#!/bin/bash

# Laravel Rollback Script
# Usage: ./rollback.sh

set -e

echo "ðŸ”„ Starting rollback..."

APP_DIR="/var/www/laravel-app"

cd $APP_DIR

# Stop current containers
echo "ðŸ›‘ Stopping current containers..."
docker-compose -f docker-compose.production.yml down

# Restore previous image
echo "â®ï¸  Restoring previous version..."
docker tag laravel-app:rollback laravel-app:latest

# Start containers
echo "â–¶ï¸  Starting containers..."
docker-compose -f docker-compose.production.yml up -d

# Wait for services
sleep 10

# Check health
if curl -f http://localhost/api/health; then
    echo "âœ… Rollback completed successfully!"
else
    echo "âŒ Rollback failed - health check failed!"
    exit 1
fi

# Show logs
docker-compose -f docker-compose.production.yml logs --tail=50 app
```

---

## health-check.sh - Application Health Check

```bash
#!/bin/bash

# Health Check Script

APP_URL="http://localhost"

echo "ðŸ¥ Running health checks..."

# Check if containers are running
echo "Checking containers..."
if ! docker ps | grep -q "laravel-app"; then
    echo "âŒ Application container not running!"
    exit 1
fi

if ! docker ps | grep -q "laravel-mysql"; then
    echo "âŒ MySQL container not running!"
    exit 1
fi

if ! docker ps | grep -q "laravel-redis"; then
    echo "âŒ Redis container not running!"
    exit 1
fi

echo "âœ… All containers running"

# Check HTTP response
echo "Checking HTTP endpoint..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL)
if [ "$HTTP_CODE" -eq 200 ]; then
    echo "âœ… HTTP endpoint responding (200)"
else
    echo "âŒ HTTP endpoint returned: $HTTP_CODE"
    exit 1
fi

# Check database connection
echo "Checking database connection..."
if docker exec laravel-app php artisan migrate:status > /dev/null 2>&1; then
    echo "âœ… Database connected"
else
    echo "âŒ Database connection failed"
    exit 1
fi

# Check Redis connection
echo "Checking Redis connection..."
if docker exec laravel-redis redis-cli ping | grep -q "PONG"; then
    echo "âœ… Redis connected"
else
    echo "âŒ Redis connection failed"
    exit 1
fi

# Check disk space
echo "Checking disk space..."
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -lt 90 ]; then
    echo "âœ… Disk usage: ${DISK_USAGE}%"
else
    echo "âš ï¸  Warning: Disk usage high: ${DISK_USAGE}%"
fi

echo ""
echo "âœ… All health checks passed!"
```

---

## logs.sh - Aggregate Log Viewer

```bash
#!/bin/bash

# View aggregated logs from all services

SERVICE=${1:-app}
LINES=${2:-100}

echo "ðŸ“‹ Viewing logs for: $SERVICE (last $LINES lines)"
echo "Available services: app, mysql, redis"
echo "Usage: ./logs.sh [service] [lines]"
echo "---"

docker-compose -f docker-compose.production.yml logs --tail=$LINES -f $SERVICE
```

---

## optimize.sh - Application Optimization

```bash
#!/bin/bash

# Optimize Laravel Application

echo "âš¡ Optimizing Laravel application..."

# Clear all caches
echo "Clearing caches..."
docker exec laravel-app php artisan cache:clear
docker exec laravel-app php artisan config:clear
docker exec laravel-app php artisan route:clear
docker exec laravel-app php artisan view:clear

# Rebuild caches
echo "Building caches..."
docker exec laravel-app php artisan config:cache
docker exec laravel-app php artisan route:cache
docker exec laravel-app php artisan view:cache

# Optimize autoloader
echo "Optimizing autoloader..."
docker exec laravel-app composer dump-autoload -o

# Clear compiled files
docker exec laravel-app php artisan clear-compiled

# Optimize application
docker exec laravel-app php artisan optimize

# Restart queue workers
echo "Restarting queue workers..."
docker exec laravel-app php artisan queue:restart

echo "âœ… Optimization completed!"
```

---

## reset-permissions.sh - Fix File Permissions

```bash
#!/bin/bash

# Reset file permissions

echo "ðŸ” Resetting file permissions..."

docker exec laravel-app chown -R www-data:www-data /var/www/html
docker exec laravel-app chmod -R 755 /var/www/html
docker exec laravel-app chmod -R 775 /var/www/html/storage
docker exec laravel-app chmod -R 775 /var/www/html/bootstrap/cache

echo "âœ… Permissions reset!"
```

---

## cleanup.sh - Docker Cleanup

```bash
#!/bin/bash

# Clean up Docker resources

echo "ðŸ§¹ Cleaning up Docker resources..."

# Remove stopped containers
echo "Removing stopped containers..."
docker container prune -f

# Remove unused images
echo "Removing unused images..."
docker image prune -a -f

# Remove unused volumes
echo "Removing unused volumes..."
docker volume prune -f

# Remove unused networks
echo "Removing unused networks..."
docker network prune -f

# Show disk usage
echo ""
echo "ðŸ“Š Docker disk usage after cleanup:"
docker system df

echo "âœ… Cleanup completed!"
```

---

## db-migrate.sh - Database Migration Helper

```bash
#!/bin/bash

# Database Migration Helper

ACTION=${1:-status}

case $ACTION in
    status)
        echo "ðŸ“Š Migration status:"
        docker exec laravel-app php artisan migrate:status
        ;;
    run)
        echo "â–¶ï¸  Running migrations..."
        docker exec laravel-app php artisan migrate --force
        ;;
    rollback)
        echo "â®ï¸  Rolling back migrations..."
        docker exec laravel-app php artisan migrate:rollback
        ;;
    fresh)
        echo "âš ï¸  DESTRUCTIVE: Fresh migration with seed"
        read -p "Are you sure? (yes/no): " confirm
        if [ "$confirm" = "yes" ]; then
            docker exec laravel-app php artisan migrate:fresh --seed --force
        else
            echo "Cancelled"
        fi
        ;;
    *)
        echo "Usage: ./db-migrate.sh [status|run|rollback|fresh]"
        exit 1
        ;;
esac
```

---

## queue-monitor.sh - Queue Monitoring

```bash
#!/bin/bash

# Monitor Laravel Queue

echo "ðŸ“Š Queue Monitoring Dashboard"
echo "---"

# Failed jobs count
FAILED=$(docker exec laravel-app php artisan queue:failed --json | grep -c "uuid")
echo "Failed jobs: $FAILED"

# Show failed jobs
if [ "$FAILED" -gt 0 ]; then
    echo ""
    echo "Failed jobs list:"
    docker exec laravel-app php artisan queue:failed
fi

# Queue worker status (from supervisor)
echo ""
echo "Queue worker status:"
docker exec laravel-app supervisorctl status laravel-worker:*

# Recent queue logs
echo ""
echo "Recent queue logs:"
docker exec laravel-app tail -20 storage/logs/worker.log

# Option to retry failed jobs
if [ "$FAILED" -gt 0 ]; then
    echo ""
    read -p "Retry all failed jobs? (yes/no): " retry
    if [ "$retry" = "yes" ]; then
        docker exec laravel-app php artisan queue:retry all
        echo "âœ… All failed jobs queued for retry"
    fi
fi
```

---

## ssl-setup.sh - SSL Certificate Setup (with Let's Encrypt)

```bash
#!/bin/bash

# SSL Certificate Setup with Let's Encrypt

DOMAIN=$1
EMAIL=$2

if [ -z "$DOMAIN" ] || [ -z "$EMAIL" ]; then
    echo "Usage: ./ssl-setup.sh domain.com your-email@example.com"
    exit 1
fi

echo "ðŸ”’ Setting up SSL for: $DOMAIN"

# Install Certbot
sudo apt update
sudo apt install -y certbot python3-certbot-nginx

# Stop application temporarily
docker-compose -f docker-compose.production.yml down

# Install temporary Nginx for certificate generation
sudo apt install -y nginx
sudo systemctl start nginx

# Get certificate
sudo certbot certonly --nginx -d $DOMAIN -d www.$DOMAIN --email $EMAIL --agree-tos --non-interactive

# Stop temporary Nginx
sudo systemctl stop nginx
sudo apt remove -y nginx

# Copy certificates to application
sudo mkdir -p /var/www/laravel-app/ssl
sudo cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem /var/www/laravel-app/ssl/
sudo cp /etc/letsencrypt/live/$DOMAIN/privkey.pem /var/www/laravel-app/ssl/

# Update Nginx config in docker-compose or add reverse proxy
echo "âš ï¸  Update your Nginx configuration to use SSL certificates"
echo "Certificates located at: /var/www/laravel-app/ssl/"

# Setup auto-renewal
(crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet --post-hook 'docker-compose -f /var/www/laravel-app/docker-compose.production.yml restart app'") | crontab -

echo "âœ… SSL setup completed!"
echo "Don't forget to update your Nginx configuration to use the certificates"
```

---

## initial-server-setup.sh - Fresh Server Setup

```bash
#!/bin/bash

# Initial Server Setup Script
# Run this on a fresh Ubuntu server

set -e

echo "ðŸš€ Starting initial server setup..."

# Update system
echo "Updating system..."
sudo apt update && sudo apt upgrade -y

# Install essential packages
echo "Installing essential packages..."
sudo apt install -y git curl wget vim ufw software-properties-common

# Install Docker
echo "Installing Docker..."
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install Docker Compose
echo "Installing Docker Compose..."
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Configure firewall
echo "Configuring firewall..."
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# Create application directory
echo "Creating application directory..."
sudo mkdir -p /var/www
sudo chown -R $USER:$USER /var/www

# Create backup directory
sudo mkdir -p /var/backups/laravel
sudo chown -R $USER:$USER /var/backups

echo "âœ… Initial server setup completed!"
echo "âš ï¸  Please log out and log back in for Docker group changes to take effect"
echo ""
echo "Next steps:"
echo "1. Log out and log back in"
echo "2. Clone your repository to /var/www/laravel-app"
echo "3. Run deployment scripts"
```

---

## Make All Scripts Executable

Run this command in your project directory:

```bash
chmod +x deploy.sh backup.sh monitor.sh rollback.sh health-check.sh logs.sh optimize.sh reset-permissions.sh cleanup.sh db-migrate.sh queue-monitor.sh ssl-setup.sh initial-server-setup.sh
```

---

## Crontab Entries for Automation

Add these to your crontab (`crontab -e`):

```bash
# Daily backup at 2 AM
0 2 * * * /var/www/laravel-app/backup.sh >> /var/log/laravel-backup.log 2>&1

# Health check every 5 minutes
*/5 * * * * /var/www/laravel-app/health-check.sh >> /var/log/laravel-health.log 2>&1

# Weekly cleanup on Sunday at 3 AM
0 3 * * 0 /var/www/laravel-app/cleanup.sh >> /var/log/laravel-cleanup.log 2>&1

# Laravel scheduler (every minute)
* * * * * docker exec laravel-app php artisan schedule:run >> /dev/null 2>&1
```

---

## Quick Command Reference

```bash
# Deploy application
./deploy.sh

# Create backup
./backup.sh

# Monitor services
./monitor.sh

# View logs
./logs.sh app 100

# Health check
./health-check.sh

# Optimize application
./optimize.sh

# Fix permissions
./reset-permissions.sh

# Clean up Docker
./cleanup.sh

# Database migrations
./db-migrate.sh status
./db-migrate.sh run

# Monitor queue
./queue-monitor.sh

# Rollback deployment
./rollback.sh
```
