{% extends "md2docx/base.html" %}

{% block title %}Home — md2docx{% endblock %}

{% block content %}
  <div class="stack">
    <div class="flex-between" style="gap:12px;">
      <div>
        <h2 style="margin:0 0 4px;">Convert Markdown to DOCX</h2>
        <p class="muted" style="margin:0;">Upload a <code>.md</code> file or paste text. We’ll queue the job and return a download link when ready.</p>
      </div>
      <span class="pill">Async conversion</span>
    </div>

    <div class="grid-2">
      <div class="card">
        <form action="{{ convert_url }}" method="post" enctype="multipart/form-data" class="stack" style="gap:14px;">
          {% csrf_token %}

          <div>
            <label for="markdown">Markdown text</label>
            <textarea id="markdown" name="markdown" rows="12" placeholder="# Hello world\n\nWrite markdown here..."></textarea>
          </div>

          <div>
            <label for="file">Or upload a file</label>
            <input type="file" id="file" name="file" accept=".md,.markdown,.docx,.html,.htm,.rtf,.odt,.tex,.epub,.pdf,text/markdown">
            <p class="muted" style="margin:6px 0 0;">We’ll auto-adjust allowed outputs based on the file extension.</p>
          </div>

          <div>
            <label for="output_format">Choose output format</label>
            <select id="output_format" name="output_format">
              {% for fmt in default_outputs %}
                <option value="{{ fmt }}" {% if fmt == 'docx' %}selected{% endif %}>{{ fmt|upper }}</option>
              {% endfor %}
            </select>
            <p class="muted" style="margin:6px 0 0;">Options change when you select a different input file type.</p>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-primary" type="submit">Convert</button>
            <span class="muted">You’ll get a task ID plus status & download URLs.</span>
          </div>
        </form>
        {{ supported_outputs|json_script:"supported-outputs-map" }}
        <script>
          (() => {
            const mappingEl = document.getElementById('supported-outputs-map');
            if (!mappingEl) return;
            const mapping = JSON.parse(mappingEl.textContent);
            const fileInput = document.getElementById('file');
            const select = document.getElementById('output_format');
            if (!fileInput || !select) return;

            const setOptions = (ext) => {
              const allowed = mapping[ext] || mapping['md'] || ['docx'];
              const prev = select.value;
              select.innerHTML = '';
              allowed.forEach((fmt) => {
                const opt = document.createElement('option');
                opt.value = fmt;
                opt.textContent = fmt.toUpperCase();
                select.appendChild(opt);
              });
              if (allowed.includes(prev)) {
                select.value = prev;
              }
            };

            fileInput.addEventListener('change', (ev) => {
              const file = ev.target.files?.[0];
              if (!file) {
                setOptions('md');
                return;
              }
              const name = file.name || '';
              const parts = name.split('.');
              const ext = parts.length > 1 ? parts.pop().toLowerCase() : 'md';
              setOptions(ext);
            });
          })();
        </script>
      </div>

      <div class="card" style="background:linear-gradient(180deg,#f8fafc,#ffffff);">
        <h3 style="margin-top:0; margin-bottom:8px;">API quick start</h3>
        <p class="muted" style="margin-top:0;">POST multipart to <code>{% url 'md2docx:api_upload' %}</code> with either <code>file</code> or <code>markdown</code>.</p>
        <pre style="background:#0f172a; color:#e5e7eb; padding:12px 14px; border-radius:10px; overflow:auto; font-size:0.9rem; line-height:1.45;">
curl -X POST {{ request.scheme }}://{{ request.get_host }}{% url 'md2docx:api_upload' %} \
  -F "file=@example.md"
        </pre>
        <p class="muted" style="margin:10px 0 4px;">Need to see progress?</p>
        <ul style="margin:0; padding-left:18px; color:#0f172a;">
          <li>Poll status: <code>/md2docx/status/&lt;task_id&gt;/</code></li>
          <li>Download: <code>/md2docx/download/&lt;task_id&gt;/</code></li>
          <li>Browse results: <a href="{% url 'md2docx:list' %}">Results list</a></li>
        </ul>
      </div>
    </div>
  </div>

{% endblock %}
